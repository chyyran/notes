# 2021-04-11 Malware

* malware
  * malicious software
  * software designed to be hostile intrusive or annoyinh
* viruses
  * replicate automatically
  * can be destructive
  * **spread secretly**
  * **needs host program**
  * **slow-spreading, needs human help**
  * goals
    * hide presence
    * replicate
  * insert instructions into existing programs
    * executed when infected program/data run or interpreted
    * tries to propagate to other programs
  * early viruses infected bootsector
  * overwrite start or end of program
    * jump to fixup (insert at start)
    * jump to virus, jump back to program start (insert at end)
      * virus length not limited if inserted at end
  * virus scanners look for signatures
    * strings of bits that correspond to known instr in viruses
    * honeypot farm to gather malware
    * malware analyzed manually to build signatures
      * heuristics/automated generation possible
    * signatures should be long enough so legit code is not mistakenly identified  (false positive)
    * signatures too long will miss variants (false negative)
  * EICAR test
    * common test signature for all AV programs to recognize
  * **polymorphic viruses**
    * vary payload to evade signature detection
    * small decryption engine decrypts rest of virus
    * simple encryption scheme to defeat signature scan (like XOR)
    * encryption key changed when virus propagates to new file, so body is never same
    * decryption engine is constant but short and simple
      * hard to build signature
    * goal is to create randomness, not security
      * advanced virus scanners run infected files inside an emulator
      * decryptor is run, virus body is decrypted
      * scanner can determien decrypted virus
  * **metamorphic viruses**
    * change their code by rewriting themselves
    * changes reg allocs
    * using equivalent instructions
    * change code block order
    * some integrate into different portions of infected program
    * might not always be executed, slowing infection rate
    * detection
      * very difficult
      * often viruses leave markers in infected files to avoid re-infecting, might be able to look at markers
* worms
  * replicate automatically
  * can be destructive
  * **spread quickly as possible**
    * take advantage of security hole before being patched
  * **standalone program**
  * **spread automatically without human interaction**
  * exploit some host vuln
  * after pwning, searches for another machine
  * can spread very fast since it requires no human intervention
  * exponential spread
  * slammer infected 90% of worldwide hosts in under 10 mins
    * eventually limited own spread because it was choking bandwith
  * morris worm
    * released in 1988
    * infteced 6000 machines
    * 2 parts
      * server
      * bootstrap/vector
      * server looked for vuln targets
      * if successful, uploaded vector (C src code), compiled and ran
      * vector downloaded rest of worm from server, and started server on infected host
    * 4 vulns
      * fingerd had buffer overflow
      * sendmail was compiled with DEBUG
        * sending string 'DEBUG' on sendmail port would give root shell
      * worm would try popular pws
      * worm would try to connect to trusted hosts on /etc/hosts.equiv
    * took precautions
      * limited already-infected machines
        * but had bugs
      * deleted (itself) files after loaded in memory
      * obscured program arguments, killed unneeded parents
  * modern worms aim to increae spread speed
    * hit list scanning
    * preseeds worm with potentially vuln hosts with high bandwidth(unis, large instututions)
    * allows worms lots of initial scanning bandwidth
    * local scanning vs random scan
      * can try infecting local host first since connection will befaster
    * UDP rather than TCP
      * UDP doesn't need handshake
      * worm doesn't have to wait for a SYN-SYNACK-ACK handshake
      * bandwidth limited rather than latency limited
  * exponential propagation
    * start slowly, then propagate rapidly until most vuln machines are exploited
    * hitlist only affects time until exponential growth
  * worm defenses
    * prevent attacks 
      * patch systems regularly
      * disabled unused services
      * hide services behind firewall
    * after release
      * shut down vuln services
      * create signature and filter at network layer
    * earlybird
      * code will appear in increasing number of netowkr messages
      * look for commonly occurring substrings in packets
    * shields
      * vulns often lie in obscure paths in untested network protocols
      * worms exercise these paths so if a protocol is in one of these paths, block
      * works as a quick fix until patch is available
* Stuxnet
  * used 4 different 0days
    * LNK vuln
    * windows printer sharing
    * windows keyboard driver
    * step7 PLC controller
  * stuxnet was **signed**
    * 2 different companies
    * someone copied unrelated private keys to sign drivers
      * (JMicron, RealTek)
  * controlled and monitored via 2 websites
    * mypremierfutbol.com received infection reports
    * todaysfutbol.com updated payloads and orchestrated running worminstances
  * were able to see geogrpahic locations of infected hosts
  * targeted iran, 5 primary infections were related to iraniannuclear production
  * PLC designed to automate mechanical systems
    * often assumed that they are isolated so poor security
  * stuxnet targeted one sepcific network
    * infected thousands of systems but did nothing
    * checking for specific combination of frequency controllers madein finland and iran
    * only ran payload if facility had exactly 33 frequency countersinstalled operating at 1064Hz
      * exact layout of iranian production facility
    * send malicious commands to speed up and slow down centrifuges
    * faked centrifuge reporting
    * actions
      * disabled monitoring alarms
      * would lay dormant for several weeks
      * speed up centrifuges for 15 minutes
      * lay dormant for another several weeks
      * drop centrifuge speed to near 0 for 15 mins
      * repeat
    * tried to sabotage iranian centrifuge
      * failure rate increased so that centrifuge failure rate between 60-70%
    * discovered and control structured dismantled before several of other known payloads deployed
* 0-day exploit
  * previously unknown, exploitable vuln
  * can be quite valuable 50k-1M on black market
  * value quickly lost if exploits are used
  * less than a dozen of 12million malwares uses 0days
* botnets
  * collection of compromised machines
  * command-and-control infrastructure
  * used for DDoS, spamming, keylogging, spyware
  * remote control facility
    * IRC, HTTP, covert channels
    * newer botnets have GP remote exec
    * spread similarly to worms
  * algorithm to rotate control servers
  * use time of day, other algo to automate actions
* rootkits
  * hide or obscure the fact that a system has been compromised
  * may be virus or worm
  * might be memory based (wont survive reboot)
  * might be persistent (stored in config, run on boot, etc.)
  * intercept library or system calls
    * user and kernel level
    * modifies returned results
    * rootkit is privileged 
  * Sony Rootkit
    * XCP
    * MediaMax CD-3
    * installed when CD inserted and interfered with the normal way OS played CD
    * no notice in EULA
    * code violated LAME/VLC licenses
    * copy protection constantly scanned system 
    * race conditions caused bluescreens
    * cripple systems if uninstalled
    * contained exploitable vulns
    * uninstaller introduced new ActiveX security hole
    * several class action lawsuits
  * defenses similar to worm and viruses (signature based detection)
    * file integrity that bypass syscalls
    * may not be able to fully clean a rootkit infected system
* trojans
  * appears to be desirable but performs some malicious actions
* spyware